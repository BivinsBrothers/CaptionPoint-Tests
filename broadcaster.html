<!doctype html>
<html>
  <head>
    <title>Broadcaster | CaptionPoint</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
  <body>
    <textarea id="source"></textarea>

    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/remark.js"></script>
    <script>
      var interval; // tracking the status timer

      // keystrokes by code
      var keyB = 66;
      var keyF = 70;
      var keyS = 83;
      var space = 32;
      var arrowLeft = 37;
      var arrowUp = 38;
      var arrowRight = 39;
      var arrowDown = 40;
      var redirectKeys = [space, arrowUp, arrowDown, arrowLeft, arrowRight];

      var slideshow = remark.create({
        sourceUrl: 'will.md',
        ratio: '16:9',
        navigation: {
          scroll: false,
        },
      });

      var slideshowState = {
        slideNumber: 0,
        blackout: false,
        fullscreen: false
      }

      $(document).ready(function() {
        var socket = io();

        function broadcastStatus(slideNumber) {
          console.log("sending status update of " + slideshowState.slideNumber);
          socket.emit('statusUpdate', slideshowState);
        }

        // This fires after remark captures keystroke
        $("body").keyup(function(event) {
          var currentSlideNumber = Number.parseInt(window.location.hash.match(/\d+/) | 0[1]);
          console.log("Broadcaster is on slide " + currentSlideNumber);

          clearInterval(interval);

          // if you type any arrow key or the space bar,
          // send redirect to the client,
          // and set status every three seconds
          if (redirectKeys.includes(event.which)) {
            slideshowState.slideNumber = currentSlideNumber;

            socket.emit('redirect', slideshowState);
            console.log("We are redirecting to slide " + slideshowState.slideNumber);

            interval = setInterval(function() {
              broadcastStatus(slideshowState);
            }, 3000);
          }

          // on "s" keyup, resend the current status
          if (event.which === keyS) {
            slideshowState.slideNumber = currentSlideNumber;

            socket.emit('redirect', slideshowState);
            interval = setInterval(function() {
              broadcastStatus(slideshowState);
            }, 3000);
          }

          // on "b" keyup, send the b keypress for blackout
          if (event.which === keyB) {
            console.log("broadcasting a b keypress");

            if (slideshowState.blackout) {
              slideshowState.blackout = false;
            } else {
              slideshowState.blackout = true;
            }

            socket.emit('blackout', slideshowState);
          }

          // on "f" keyup, send the f keypress for fullscreen
          if (event.which === keyF) {
            console.log("broadcasting an f keypress");

            if (slideshowState.fullscreen) {
              slideshowState.fullscreen = false;
            } else {
              slideshowState.fullscreen = true;
            }

            socket.emit('fullscreen', slideshowState);
          }
        });
      });
    </script>
  </body>
</html>
